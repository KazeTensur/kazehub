-- ================= KAZEHUB COMPLETE VERSION =================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "KazeHub!",
    Icon = 0,
    LoadingTitle = "Welcome to KazeHub!",
    LoadingSubtitle = "by Kaze",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Kazehub",
        FileName = "kazehub"
    }
})

-- ================= SERVICES =================
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local RemoteEvent = game:GetService("ReplicatedStorage")
    :WaitForChild("API")
    :WaitForChild("Utils")
    :WaitForChild("network")
    :WaitForChild("RemoteEvent")

local WorldsFolder = workspace:WaitForChild("Worlds", 10)
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

-- ================= STATE =================
local SelectedMode = "Story"
local SelectedMap = nil
local SelectedAct = "1"
local SelectedDifficulty = "Normal"
local RaidMaps = {"Vastora Realm","Ember Village","Power Arena"}
local customWebhook = ""

-- ================= FUNCTIONS =================
local function getSortedMaps()
    local list = {}
    if WorldsFolder then
        for _, map in ipairs(WorldsFolder:GetChildren()) do
            if map:IsA("Model") or map:IsA("Folder") then
                table.insert(list, map.Name)
            end
        end
    end
    table.sort(list, function(a,b) return a:lower() < b:lower() end)
    return list
end

local function runAutoJoin()
    if not SelectedMap then 
        Rayfield:Notify({Title = "Missing Information", Content = "Please select a map before starting!", Duration = 3})
        return 
    end

    local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    if SelectedMode == "Story" then
        RemoteEvent:FireServer("battle_start", "story", SelectedMap, tonumber(SelectedAct), SelectedDifficulty)
        print("ðŸš€ Started Story: " .. SelectedMap)
    elseif SelectedMode == "Raid" then
        local raidFolder = workspace:WaitForChild("Rooms"):WaitForChild("raid")
        for _, roomModel in ipairs(raidFolder:GetChildren()) do
            local touchPart = roomModel:FindFirstChild("Touch", true)
            if touchPart and touchPart:IsA("BasePart") then
                firetouchinterest(hrp, touchPart, 0)
                task.wait(0.1)
                firetouchinterest(hrp, touchPart, 1)
                task.wait(0.5)
                RemoteEvent:FireServer("room_select", SelectedMap, 1)
                task.wait(0.3)
                RemoteEvent:FireServer("room_start")
                print("âœ… Started Raid: " .. SelectedMap)
                break
            end
        end
    end
end

-- ================= UI TAB 1 â€” LOBBY / FARM =================
local Main = Window:CreateTab("Lobby / Farm", 4483362458)
local MapDropdown

Main:CreateDropdown({
    Name = "1. Select Mode",
    Options = {"Story","Raid"},
    CurrentOption = {"Story"},
    Flag = "SelectedMode",
    Callback = function(opt)
        SelectedMode = opt[1]
        if MapDropdown then
            MapDropdown:Refresh(SelectedMode == "Raid" and RaidMaps or getSortedMaps(), true)
        end
    end
})

MapDropdown = Main:CreateDropdown({
    Name = "2. Select Map",
    Options = getSortedMaps(),
    CurrentOption = {},
    Flag = "SelectedMap",
    Callback = function(opt) SelectedMap = opt[1] end
})

Main:CreateDropdown({
    Name = "3. Select Act",
    Options = {"1","2","3","4","5","6","7","8","9","10"},
    CurrentOption = {"1"},
    Flag = "SelectedAct",
    Callback = function(opt) SelectedAct = opt[1] end
})

Main:CreateDropdown({
    Name = "4. Difficulty",
    Options = {"Normal","Hard","Nightmare"},
    CurrentOption = {"Normal"},
    Flag = "SelectedDifficulty",
    Callback = function(opt) SelectedDifficulty = opt[1] end
})

Main:CreateToggle({
    Name = "Auto Join & Start",
    CurrentValue = false,
    Flag = "AutoJoin",
    Callback = function(val)
        if val then
            runAutoJoin()
            Rayfield:Notify({Title = "KazeHub", Content = "Joining match...", Duration = 2})
        end
    end
})

-- ================= UI TAB 2 â€” WEBHOOK =================
local Tab2 = Window:CreateTab("Webhook", 4483362458)

Tab2:CreateInput({
    Name = "Webhook Link",
    CurrentValue = customWebhook,
    PlaceholderText = "Paste Discord webhook here",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        customWebhook = Text
    end,
})

Tab2:CreateButton({
    Name = "Test Webhook",
    Callback = function()
        if customWebhook == "" then
            Rayfield:Notify({
                Title = "Webhook",
                Content = "Webhook link not set!",
                Duration = 2.5,
                Image = 4483362458,
            })
            return
        end
        local testData = {
            username = "Webhook Tester",
            embeds = {{
                title = "âœ… TEST WEBHOOK",
                description = "Webhook works properly!",
                color = 0x3498db
            }}
        }
        pcall(function()
            local http_request =
                (syn and syn.request)
                or (http and http.request)
                or (fluxus and fluxus.request)
                or request
            http_request({
                Url = customWebhook,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(testData)
            })
        end)
        Rayfield:Notify({
            Title = "Webhook",
            Content = "âœ… Test webhook successful!",
            Duration = 2.5,
            Image = 4483362458,
        })
    end,
})

Tab2:CreateButton({
    Name = "Save Webhook",
    Callback = function()
        if customWebhook ~= "" then
            writefile("custom_webhook.txt", customWebhook)
            Rayfield:Notify({
                Title = "Webhook",
                Content = "ðŸ’¾ Webhook saved successfully!",
                Duration = 2.5,
                Image = 4483362458,
            })
        else
            Rayfield:Notify({
                Title = "Webhook",
                Content = "Webhook link not set!",
                Duration = 2.5,
                Image = 4483362458,
            })
        end
    end,
})

-- ================= UI TAB 3 â€” MISC =================
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- ================= ANTI-AFK FIX =================
local AntiAFKEnabled = false
local AntiAFKThread
local AntiAFKConnection

local function StartAntiAFK()
    if AntiAFKEnabled then return end
    AntiAFKEnabled = true
    AntiAFKConnection = lp.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new(0,0))
    end)
    AntiAFKThread = task.spawn(function()
        while AntiAFKEnabled do
            task.wait(30)
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new(0,0))
        end
    end)
    print("ðŸŸ¢ Anti-AFK started")
end

local function StopAntiAFK()
    AntiAFKEnabled = false
    if AntiAFKConnection then AntiAFKConnection:Disconnect() AntiAFKConnection = nil end
    if AntiAFKThread then task.cancel(AntiAFKThread) AntiAFKThread = nil end
    print("ðŸ”´ Anti-AFK stopped")
end

MiscTab:CreateToggle({
    Name = "Anti-AFK",
    CurrentValue = false,
    Flag = "AntiAFK",
    Callback = function(Value)
        if Value then
            StartAntiAFK()
            Rayfield:Notify({Title = "Anti-AFK", Content = "âœ… Anti-AFK enabled", Duration = 2.5, Image = 4483362458})
        else
            StopAntiAFK()
            Rayfield:Notify({Title = "Anti-AFK", Content = "âŒ Anti-AFK disabled", Duration = 2.5, Image = 4483362458})
        end
    end
})

-- ================= FPS BOOST =================
local FPSBoostEnabled = false
MiscTab:CreateToggle({
    Name = "FPS Boost",
    CurrentValue = false,
    Flag = "FPSBoost",
    Callback = function(Value)
        FPSBoostEnabled = Value
        if Value then
            for _, v in pairs(Workspace:GetDescendants()) do
                if v:IsA("Part") or v:IsA("UnionOperation") or v:IsA("MeshPart") then
                    v.Material = Enum.Material.Plastic
                    v.Reflectance = 0
                end
            end
            Lighting.GlobalShadows = false
            Lighting.FogEnd = 9e9
            Lighting.Brightness = 2
            Workspace.StreamingEnabled = false
            for _, particle in pairs(Workspace:GetDescendants()) do
                if particle:IsA("ParticleEmitter") or particle:IsA("Trail") then
                    particle:Destroy()
                end
            end
            Rayfield:Notify({Title = "Performance", Content = "ðŸš€ FPS Boost enabled", Duration = 2.5, Image = 4483362458})
        else
            Lighting.GlobalShadows = true
            Workspace.StreamingEnabled = true
            Rayfield:Notify({Title = "Performance", Content = "âš™ï¸ FPS Boost disabled", Duration = 2.5, Image = 4483362458})
        end
    end
})

-- ================= SAVE CONFIG =================
MiscTab:CreateButton({
    Name = "Save Config",
    Callback = function()
        Rayfield:SaveConfiguration()
        Rayfield:Notify({Title = "Config", Content = "ðŸ’¾ Configuration saved successfully!", Duration = 2.5, Image = 4483362458})
    end
})

-- ================= REJOIN =================
MiscTab:CreateButton({
    Name = "Rejoin",
    Callback = function()
        Rayfield:Notify({Title = "Rejoin", Content = "â³ Rejoining server...", Duration = 2.5, Image = 4483362458})
        TeleportService:Teleport(game.PlaceId, lp)
    end
})

-- ================= LOAD CONFIG =================
Rayfield:LoadConfiguration()

-- ================= AUTO RE-ENABLE AFTER LOAD CONFIG =================
task.delay(0.5, function()
    local flags = Rayfield.Flags
    -- Anti-AFK
    if flags.AntiAFK and flags.AntiAFK.CurrentValue == true then
        StartAntiAFK()
        print("ðŸ” Anti-AFK auto re-enabled from config")
    end
    -- Auto Join
    if flags.AutoJoin and flags.AutoJoin.CurrentValue == true then
        runAutoJoin()
        print("ðŸš€ Auto Join re-triggered from config")
    end
end)

print("âœ… KazeHub Loaded Complete")
