-- ================= KAZEHUB FINAL CLEAN =================
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "KazeHub!",
    LoadingTitle = "Welcome to KazeHub!",
    LoadingSubtitle = "by Kaze",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Kazehub",
        FileName = "kazehub"
    }
})

-- ================= SERVICES =================
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RemoteEvent = ReplicatedStorage:WaitForChild("API"):WaitForChild("Utils")
    :WaitForChild("network"):WaitForChild("RemoteEvent")

local WorldsFolder = Workspace:WaitForChild("Worlds", 10)

-- ================= STATE =================
local SelectedMode = "Story"
local SelectedMap = nil
local SelectedAct = 1
local SelectedDifficulty = "Normal"
local RaidMaps = {"Vastora Realm","Ember Village","Power Arena"}

local WebhookEnabled = true
local customWebhook = ""
local AutoJoinEnabled = false
local AutoChallengeEnabled = false
local AutoEquipTeam = false
local IgnoredDebuffs = {}

local requestFunc = (syn and syn.request) or (http and http.request) or request or http_request

-- ================= SAFE HELPERS =================
local function isPlayerInBattle()
    return lp.PlayerGui:FindFirstChild("battle") ~= nil
end

local function getSortedMaps()
    local maps = {}
    if WorldsFolder then
        for _, v in pairs(WorldsFolder:GetChildren()) do
            table.insert(maps, v.Name)
        end
    end
    table.sort(maps)
    return maps
end

-- ================= WEBHOOK =================
local function sendDiscord(payload)
    if not WebhookEnabled or customWebhook == "" then return end
    if not requestFunc then return end

    local proxy = customWebhook:gsub("discord.com", "webhook.lewisakura.moe")

    task.spawn(function()
        pcall(function()
            requestFunc({
                Url = proxy,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(payload)
            })
        end)
    end)
end

-- ================= AUTO JOIN =================
local function runAutoJoin()
    if not SelectedMap then return end

    if SelectedMode == "Story" then
        RemoteEvent:FireServer(
            "battle_start",
            "story",
            SelectedMap,
            SelectedAct,
            SelectedDifficulty
        )
    elseif SelectedMode == "Raid" then
        RemoteEvent:FireServer("room_select", SelectedMap, 1)
        task.wait(0.3)
        RemoteEvent:FireServer("room_start")
    end
end

-- ================= UI TAB: FARM =================
local Main = Window:CreateTab("Lobby / Farm", 4483362458)

Main:CreateDropdown({
    Name = "Select Mode",
    Options = {"Story","Raid"},
    CurrentOption = {"Story"},
    Callback = function(opt)
        SelectedMode = opt[1]
    end
})

Main:CreateDropdown({
    Name = "Select Map",
    Options = getSortedMaps(),
    Callback = function(opt)
        SelectedMap = opt[1]
    end
})

Main:CreateDropdown({
    Name = "Select Act",
    Options = {"1","2","3","4","5","6","7","8","9","10"},
    CurrentOption = {"1"},
    Callback = function(opt)
        SelectedAct = tonumber(opt[1])
    end
})

Main:CreateDropdown({
    Name = "Difficulty",
    Options = {"Normal","Hard","Nightmare"},
    CurrentOption = {"Normal"},
    Callback = function(opt)
        SelectedDifficulty = opt[1]
    end
})

Main:CreateToggle({
    Name = "Auto Join & Start",
    CurrentValue = false,
    Callback = function(v)
        AutoJoinEnabled = v
        if v and not isPlayerInBattle() then
            runAutoJoin()
        end
    end
})

-- ================= UI TAB: CHALLENGE =================
local ChallengeTab = Window:CreateTab("Challenges", 4483362458)

ChallengeTab:CreateToggle({
    Name = "Auto Equip Team",
    Callback = function(v)
        AutoEquipTeam = v
    end
})

ChallengeTab:CreateDropdown({
    Name = "Ignore Debuffs",
    MultipleOptions = true,
    Options = {
        "Double Stats",
        "Burn Enemies",
        "Poison Enemies",
        "Weakened Units"
    },
    Callback = function(opts)
        IgnoredDebuffs = opts
    end
})

ChallengeTab:CreateToggle({
    Name = "Smart Auto Challenge",
    Callback = function(v)
        AutoChallengeEnabled = v
    end
})

-- ================= UI TAB: WEBHOOK =================
local WebTab = Window:CreateTab("Webhook", 4483362458)

WebTab:CreateToggle({
    Name = "Enable Webhook",
    CurrentValue = true,
    Callback = function(v)
        WebhookEnabled = v
    end
})

WebTab:CreateInput({
    Name = "Webhook URL",
    PlaceholderText = "Paste Discord Webhook",
    Callback = function(txt)
        customWebhook = txt
    end
})

WebTab:CreateButton({
    Name = "Test Webhook",
    Callback = function()
        sendDiscord({
            content = "✅ KazeHub webhook hoạt động!"
        })
        Rayfield:Notify({
            Title = "Webhook",
            Content = "Đã gửi test webhook",
            Duration = 2
        })
    end
})

-- ================= UI TAB: MISC =================
local Misc = Window:CreateTab("Misc", 4483362458)

Misc:CreateToggle({
    Name = "Anti-AFK",
    Callback = function(v)
        if v then
            lp.Idled:Connect(function()
                VirtualUser:CaptureController()
                VirtualUser:ClickButton2(Vector2.new(0,0))
            end)
        end
    end
})

Misc:CreateToggle({
    Name = "FPS Boost",
    Callback = function(v)
        if v then
            Lighting.GlobalShadows = false
            Lighting.FogEnd = 9e9
            for _, obj in pairs(Workspace:GetDescendants()) do
                if obj:IsA("ParticleEmitter") or obj:IsA("Trail") then
                    obj:Destroy()
                end
            end
        else
            Lighting.GlobalShadows = true
        end
    end
})

Misc:CreateButton({
    Name = "Rejoin",
    Callback = function()
        TeleportService:Teleport(game.PlaceId, lp)
    end
})

Rayfield:LoadConfiguration()
