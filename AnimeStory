-- ================= KAZEHUB COMPLETE VERSION (FIXED & OPTIMIZED) =================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "KazeHub!",
    Icon = 0,
    LoadingTitle = "Welcome to KazeHub!",
    LoadingSubtitle = "by Kaze",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Kazehub",
        FileName = "kazehub"
    }
})

-- ================= SERVICES =================
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")

local RemoteEvent = game:GetService("ReplicatedStorage")
    :WaitForChild("API")
    :WaitForChild("Utils")
    :WaitForChild("network")
    :WaitForChild("RemoteEvent")

local WorldsFolder = workspace:WaitForChild("Worlds", 10)

-- ================= STATE =================
local SelectedMode = "Story"
local SelectedMap = nil
local SelectedAct = "1"
local SelectedDifficulty = "Normal"
local RaidMaps = {"Vastora Realm","Ember Village","Power Arena"}
local customWebhook = ""
local WebhookEnabled = true
local AutoChallengeEnabled = false
local IgnoredDebuffs = {}

local s_request = (syn and syn.request) or (http and http.request) or http_request or request

-- ================= LOAD WEBHOOK =================
pcall(function()
    if isfile("custom_webhook.txt") then
        customWebhook = readfile("custom_webhook.txt")
    end
end)

-- ================= HELPER FUNCTIONS =================
local function getSortedMaps()
    local list = {}
    if WorldsFolder then
        for _, map in ipairs(WorldsFolder:GetChildren()) do
            if map:IsA("Model") or map:IsA("Folder") then
                table.insert(list, map.Name)
            end
        end
    end
    table.sort(list, function(a,b) return a:lower() < b:lower() end)
    return list
end

local function getTotalBalance()
    local data = lp:FindFirstChild("Data")
    if not data then return "N/A" end
    return string.format("üí∞ Coins: %s\nüíé Gems: %s", data.Coins.Value, data.Gems.Value)
end

-- Fix l·ªói IMG_3122 b·∫±ng c√°ch ki·ªÉm tra .Enabled c·ªßa ScreenGui
local function isPlayerInBattle()
    local battleGui = lp.PlayerGui:FindFirstChild("battle")
    if battleGui then
        return battleGui.Enabled 
    end
    return false
end

-- ================= WEBHOOK SYSTEM (SAFE PROXY) =================
local function sendDiscord(custom_payload)
    if not WebhookEnabled or customWebhook == "" or not s_request then return end
    local proxyUrl = customWebhook:gsub("discord.com", "webhook.lewisakura.moe")
    
    task.spawn(function()
        pcall(function()
            s_request({
                Url = proxyUrl,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(custom_payload)
            })
        end)
    end)
end

-- ================= FARM LOGIC =================
local function runAutoJoin()
    if not SelectedMap then return end
    local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    if SelectedMode == "Story" then
        RemoteEvent:FireServer("battle_start", "story", SelectedMap, tonumber(SelectedAct), SelectedDifficulty)
    elseif SelectedMode == "Raid" then
        local raidFolder = workspace:WaitForChild("Rooms"):WaitForChild("raid")
        for _, roomModel in ipairs(raidFolder:GetChildren()) do
            local touchPart = roomModel:FindFirstChild("Touch", true)
            if touchPart then
                firetouchinterest(hrp, touchPart, 0)
                task.wait(0.1)
                firetouchinterest(hrp, touchPart, 1)
                task.wait(0.5)
                RemoteEvent:FireServer("room_select", SelectedMap, 1)
                task.wait(0.3)
                RemoteEvent:FireServer("room_start")
                break
            end
        end
    end
end

-- ================= SMART CHALLENGE LOGIC =================
local function getLiveChallengeData()
    local success, result = pcall(function()
        -- ƒê∆∞·ªùng d·∫´n chu·∫©n t·ª´ ·∫£nh IMG_3120
        local baseUI = workspace.Lobby.ChallengeInfo["Semi-Hourly"].Model.Part.SurfaceGui.Base
        local rewardsList = {}
        for _, child in ipairs(baseUI.Rewards:GetChildren()) do
            if child:IsA("GuiObject") then
                table.insert(rewardsList, child.Name)
            end
        end
        return {
            Map = baseUI.MapName.Text,
            Debuff = baseUI.Debuff.Text,
            Rewards = #rewardsList > 0 and table.concat(rewardsList, ", ") or "N/A"
        }
    end)
    return success and result or {Map = "N/A", Debuff = "N/A", Rewards = "N/A"}
end

local function joinChallengeRoom()
    local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    -- ƒê∆∞·ªùng d·∫´n chu·∫©n t·ª´ ·∫£nh IMG_3121
    local touchPart = workspace.Rooms.challenges.Model.Touch
    local liveData = getLiveChallengeData()

    if hrp and touchPart and liveData.Map ~= "N/A" then
        -- Teleport nh·∫π t·ªõi v·ªã tr√≠ Touch ƒë·ªÉ ƒë·∫£m b·∫£o trigger
        hrp.CFrame = touchPart.CFrame * CFrame.new(0, 2, 0)
        task.wait(0.2)
        
        firetouchinterest(hrp, touchPart, 0)
        task.wait(0.1)
        firetouchinterest(hrp, touchPart, 1)
        task.wait(0.8)

        -- Remote Select ch√≠nh x√°c v·ªõi Act 7 v√† Debuff Table
        RemoteEvent:FireServer("room_select", liveData.Map, 7, {
            ["ChallengeType"] = "Semi-Hourly",
            ["Debuff"] = liveData.Debuff
        })
        
        task.wait(0.5)
        RemoteEvent:FireServer("room_start")
    end
end

-- ================= UI TAB 1 ‚Äî LOBBY / FARM =================
local Main = Window:CreateTab("Lobby / Farm", 4483362458)
local MapDropdown

Main:CreateDropdown({
    Name = "1. Select Mode",
    Options = {"Story","Raid"},
    CurrentOption = {"Story"},
    Callback = function(opt)
        SelectedMode = opt[1]
        if MapDropdown then
            MapDropdown:Refresh(SelectedMode == "Raid" and RaidMaps or getSortedMaps(), true)
        end
    end
})

MapDropdown = Main:CreateDropdown({
    Name = "2. Select Map",
    Options = getSortedMaps(),
    CurrentOption = {},
    Callback = function(opt) SelectedMap = opt[1] end
})

Main:CreateDropdown({
    Name = "3. Select Act",
    Options = {"1","2","3","4","5","6","7","8","9","10"},
    CurrentOption = {"1"},
    Callback = function(opt) SelectedAct = opt[1] end
})

Main:CreateDropdown({
    Name = "4. Difficulty",
    Options = {"Normal","Hard","Nightmare"},
    CurrentOption = {"Normal"},
    Callback = function(opt) SelectedDifficulty = opt[1] end
})

Main:CreateToggle({
    Name = "Auto Join & Start",
    CurrentValue = false,
    Callback = function(val) if val then runAutoJoin() end end
})

-- ================= UI TAB 2 ‚Äî CHALLENGES =================
local ChallengeTab = Window:CreateTab("Challenges", 4483362458)

ChallengeTab:CreateDropdown({
    Name = "Ignore Debuffs (Multi-select)",
    Options = {"Double Stats", "Weakened Units", "Burn Enemies", "Poison Enemies"},
    CurrentOption = {},
    MultipleOptions = true,
    Callback = function(Options) IgnoredDebuffs = Options end
})

local ChalStatus = ChallengeTab:CreateLabel("Status: Waiting...")

ChallengeTab:CreateToggle({
    Name = "Smart Auto Challenge",
    CurrentValue = false,
    Callback = function(val)
        AutoChallengeEnabled = val
        if val then
            task.spawn(function()
                while AutoChallengeEnabled do
                    if not isPlayerInBattle() then
                        local data = getLiveChallengeData()
                        ChalStatus:Set("Map: "..data.Map.." | Debuff: "..data.Debuff)
                        
                        local isIgnored = false
                        for _, skip in ipairs(IgnoredDebuffs) do
                            if data.Debuff:find(skip) then isIgnored = true break end
                        end
                        
                        if not isIgnored and data.Map ~= "N/A" then
                            joinChallengeRoom()
                        end
                    end
                    task.wait(15)
                end
            end)
        end
    end
})

-- ================= UI TAB 3 ‚Äî WEBHOOK =================
local Tab2 = Window:CreateTab("Webhook", 4483362458)

Tab2:CreateToggle({
    Name = "Enable Webhook",
    CurrentValue = true,
    Callback = function(v) WebhookEnabled = v end
})

Tab2:CreateInput({
    Name = "Link Webhook",
    CurrentValue = customWebhook,
    PlaceholderText = "D√°n webhook Discord",
    Callback = function(txt) customWebhook = txt end,
})

Tab2:CreateButton({
    Name = "Save Webhook",
    Callback = function() writefile("custom_webhook.txt", customWebhook) end
})

-- ================= UI TAB 4 ‚Äî MISC =================
local MiscTab = Window:CreateTab("Misc", 4483362458)

local AntiAFKEnabled = false
local AntiAFKConnection

MiscTab:CreateToggle({
    Name = "Anti-AFK",
    CurrentValue = false,
    Callback = function(Value)
        AntiAFKEnabled = Value
        if Value then
            AntiAFKConnection = lp.Idled:Connect(function()
                VirtualUser:CaptureController()
                VirtualUser:ClickButton2(Vector2.new(0,0))
            end)
        else
            if AntiAFKConnection then AntiAFKConnection:Disconnect() end
        end
    end
})

MiscTab:CreateToggle({
    Name = "FPS Boost",
    CurrentValue = false,
    Callback = function(Value)
        if Value then
            for _, v in pairs(Workspace:GetDescendants()) do
                if v:IsA("Part") then v.Material = Enum.Material.Plastic v.Reflectance = 0 end
            end
            Lighting.GlobalShadows = false
        else
            Lighting.GlobalShadows = true
        end
    end
})

MiscTab:CreateButton({
    Name = "Rejoin",
    Callback = function() TeleportService:Teleport(game.PlaceId, lp) end
})

-- ================= AUTO WEBHOOK RESULT =================
task.spawn(function()
    local resultUI = lp.PlayerGui:WaitForChild("battle"):WaitForChild("Result")
    local sent = false
    while true do
        if resultUI.Visible then
            if not sent then
                sent = true
                task.wait(2)
                local stage = resultUI.Base.Content.Stage.Text
                local res = resultUI.Base.Content.Result.Text
                sendDiscord({
                    ["embeds"] = {{
                        ["title"] = res,
                        ["description"] = "Player: " .. lp.Name .. "\nStage: " .. stage,
                        ["fields"] = {{["name"] = "Balance", ["value"] = getTotalBalance()}}
                    }}
                })
            end
        else
            sent = false
        end
        task.wait(2)
    end
end)

Rayfield:LoadConfiguration()
print("‚úÖ KazeHub Fully Loaded & Fixed")
