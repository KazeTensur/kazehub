-- ================= KAZEHUB COMPLETE VERSION (DELTA X + CHALLENGE) =================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "KazeHub!",
    Icon = 0,
    LoadingTitle = "Welcome to KazeHub!",
    LoadingSubtitle = "by Kaze",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Kazehub",
        FileName = "kazehub"
    }
})

-- ================= SERVICES =================
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")

local RemoteEvent = game:GetService("ReplicatedStorage")
    :WaitForChild("API")
    :WaitForChild("Utils")
    :WaitForChild("network")
    :WaitForChild("RemoteEvent")

local WorldsFolder = workspace:WaitForChild("Worlds", 10)

-- ================= STATE =================
local SelectedMode = "Story"
local SelectedMap = nil
local SelectedAct = "1"
local SelectedDifficulty = "Normal"
local RaidMaps = {"Vastora Realm","Ember Village","Power Arena"}

-- Challenge state
local AutoChallengeEnabled = false
local AutoEquipTeam = false
local IgnoredDebuffs = {}

local customWebhook = ""
local WebhookEnabled = true

local s_request = (syn and syn.request) or (http and http.request) or http_request or request

-- ================= LOAD WEBHOOK =================
pcall(function()
    if isfile("custom_webhook.txt") then
        customWebhook = readfile("custom_webhook.txt")
    end
end)

-- ================= HELPERS =================
local function getSortedMaps()
    local list = {}
    if WorldsFolder then
        for _, map in ipairs(WorldsFolder:GetChildren()) do
            if map:IsA("Model") or map:IsA("Folder") then
                table.insert(list, map.Name)
            end
        end
    end
    table.sort(list, function(a,b) return a:lower() < b:lower() end)
    return list
end

local function isPlayerInBattle()
    local gui = lp.PlayerGui:FindFirstChild("battle")
    return gui and gui.Enabled
end

-- ================= AUTO JOIN =================
local function runAutoJoin()
    if not SelectedMap then return end
    if SelectedMode == "Story" then
        RemoteEvent:FireServer("battle_start", "story", SelectedMap, tonumber(SelectedAct), SelectedDifficulty)
    elseif SelectedMode == "Raid" then
        local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
        local raidFolder = workspace:WaitForChild("Rooms"):WaitForChild("raid")
        for _, room in ipairs(raidFolder:GetChildren()) do
            local touch = room:FindFirstChild("Touch", true)
            if touch and hrp then
                firetouchinterest(hrp, touch, 0)
                firetouchinterest(hrp, touch, 1)
                task.wait(0.4)
                RemoteEvent:FireServer("room_select", SelectedMap, 1)
                task.wait(0.2)
                RemoteEvent:FireServer("room_start")
                break
            end
        end
    end
end

-- ================= MAIN TAB =================
local Main = Window:CreateTab("Lobby / Farm", 4483362458)
local MapDropdown

Main:CreateDropdown({
    Name = "1. Select Mode",
    Options = {"Story","Raid"},
    CurrentOption = {"Story"},
    Callback = function(opt)
        SelectedMode = opt[1]
        MapDropdown:Refresh(SelectedMode == "Raid" and RaidMaps or getSortedMaps(), true)
    end
})

MapDropdown = Main:CreateDropdown({
    Name = "2. Select Map",
    Options = getSortedMaps(),
    CurrentOption = {},
    Callback = function(opt) SelectedMap = opt[1] end
})

Main:CreateDropdown({
    Name = "3. Select Act",
    Options = {"1","2","3","4","5","6","7","8","9","10"},
    CurrentOption = {"1"},
    Callback = function(opt) SelectedAct = opt[1] end
})

Main:CreateDropdown({
    Name = "4. Difficulty",
    Options = {"Normal","Hard","Nightmare"},
    CurrentOption = {"Normal"},
    Callback = function(opt) SelectedDifficulty = opt[1] end
})

Main:CreateToggle({
    Name = "Auto Join & Start",
    CurrentValue = false,
    Callback = function(v)
        if v and not isPlayerInBattle() then runAutoJoin() end
    end
})

-- =====================================================================
-- ====================== CHALLENGE TAB (NEW) ===========================
-- =====================================================================
local ChallengeTab = Window:CreateTab("Challenges", 4483362458)

ChallengeTab:CreateLabel("⚠️ Requires saved team in SLOT 1")

ChallengeTab:CreateToggle({
    Name = "Auto Equip Team (Slot 1)",
    CurrentValue = false,
    Callback = function(v) AutoEquipTeam = v end
})

ChallengeTab:CreateDropdown({
    Name = "Ignore Debuffs",
    Options = {
        "Double Stats",
        "Weakened Units",
        "Burn Enemies",
        "Poison Enemies"
    },
    MultipleOptions = true,
    CurrentOption = {},
    Callback = function(opts) IgnoredDebuffs = opts end
})

local StatusLabel = ChallengeTab:CreateLabel("Status: Waiting...")

-- ===== Challenge helpers =====
local function getLiveChallengeData()
    local ok, data = pcall(function()
        local ui = workspace.Lobby.ChallengeInfo["Semi-Hourly"].Model.Part.SurfaceGui.Base
        return {
            Map = ui.MapName.Text,
            Debuff = ui.Debuff.Text
        }
    end)
    return ok and data or {Map="N/A",Debuff="N/A"}
end

local function joinChallenge()
    local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    local touch = workspace.Rooms.challenges.Model.Touch
    local data = getLiveChallengeData()

    if not hrp or not touch or data.Map == "N/A" then return end

    for _, skip in ipairs(IgnoredDebuffs) do
        if data.Debuff:find(skip) then return end
    end

    if AutoEquipTeam then
        RemoteEvent:FireServer("equip_team", 1)
        task.wait(1)
    end

    hrp.CFrame = touch.CFrame * CFrame.new(0,2,0)
    firetouchinterest(hrp, touch, 0)
    firetouchinterest(hrp, touch, 1)

    task.wait(0.6)
    RemoteEvent:FireServer("room_select", data.Map, 7, {
        ChallengeType = "Semi-Hourly",
        Debuff = data.Debuff
    })
    task.wait(0.3)
    RemoteEvent:FireServer("room_start")
end

ChallengeTab:CreateToggle({
    Name = "Smart Auto Challenge",
    CurrentValue = false,
    Callback = function(v)
        AutoChallengeEnabled = v
        if v then
            task.spawn(function()
                while AutoChallengeEnabled do
                    if not isPlayerInBattle() then
                        local d = getLiveChallengeData()
                        StatusLabel:Set("Map: "..d.Map.." | "..d.Debuff)
                        joinChallenge()
                    end
                    task.wait(15)
                end
            end)
        end
    end
})

-- ================= WEBHOOK TAB (GIỮ NGUYÊN) =================
local Tab2 = Window:CreateTab("Webhook", 4483362458)

Tab2:CreateToggle({
    Name = "Enable Webhook",
    CurrentValue = true,
    Callback = function(v) WebhookEnabled = v end
})

Tab2:CreateInput({
    Name = "Link Webhook",
    CurrentValue = customWebhook,
    PlaceholderText = "Dán webhook Discord",
    Callback = function(txt) customWebhook = txt end
})

Tab2:CreateButton({
    Name = "Save Webhook",
    Callback = function()
        writefile("custom_webhook.txt", customWebhook)
        Rayfield:Notify({Title="Saved",Content="Webhook saved",Duration=2})
    end
})

-- ================= MISC TAB (GIỮ NGUYÊN) =================
local MiscTab = Window:CreateTab("Misc", 4483362458)

MiscTab:CreateToggle({
    Name = "Anti-AFK",
    CurrentValue = false,
    Callback = function(v)
        if v then
            _G.AFK = lp.Idled:Connect(function()
                VirtualUser:CaptureController()
                VirtualUser:ClickButton2(Vector2.new(0,0))
            end)
        else
            if _G.AFK then _G.AFK:Disconnect() end
        end
    end
})

MiscTab:CreateButton({
    Name = "Rejoin",
    Callback = function()
        TeleportService:Teleport(game.PlaceId, lp)
    end
})

Rayfield:LoadConfiguration()
print("✅ KazeHub Loaded (Main → Challenge → Webhook → Misc)")
