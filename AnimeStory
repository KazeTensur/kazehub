-- ================= KAZEHUB COMPLETE VERSION (FIXED WEBHOOK) =================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "KazeHub!",
    Icon = 0,
    LoadingTitle = "Welcome to KazeHub!",
    LoadingSubtitle = "by Kaze",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Kazehub",
        FileName = "kazehub"
    }
})

-- ================= SERVICES =================
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local RemoteEvent = game:GetService("ReplicatedStorage")
    :WaitForChild("API")
    :WaitForChild("Utils")
    :WaitForChild("network")
    :WaitForChild("RemoteEvent")

local WorldsFolder = workspace:WaitForChild("Worlds", 10)
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

-- ================= STATE =================
local SelectedMode = "Story"
local SelectedMap = nil
local SelectedAct = "1"
local SelectedDifficulty = "Normal"
local RaidMaps = {"Vastora Realm","Ember Village","Power Arena"}
local customWebhook = ""

-- ================= FUNCTIONS =================
local function getSortedMaps()
    local list = {}
    if WorldsFolder then
        for _, map in ipairs(WorldsFolder:GetChildren()) do
            if map:IsA("Model") or map:IsA("Folder") then
                table.insert(list, map.Name)
            end
        end
    end
    table.sort(list, function(a,b) return a:lower() < b:lower() end)
    return list
end

local function runAutoJoin()
    if not SelectedMap then 
        Rayfield:Notify({Title = "Missing Information", Content = "Please select a map before starting!", Duration = 3})
        return 
    end

    local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    if SelectedMode == "Story" then
        RemoteEvent:FireServer("battle_start", "story", SelectedMap, tonumber(SelectedAct), SelectedDifficulty)
    elseif SelectedMode == "Raid" then
        local raidFolder = workspace:WaitForChild("Rooms"):WaitForChild("raid")
        for _, roomModel in ipairs(raidFolder:GetChildren()) do
            local touchPart = roomModel:FindFirstChild("Touch", true)
            if touchPart and touchPart:IsA("BasePart") then
                firetouchinterest(hrp, touchPart, 0)
                task.wait(0.1)
                firetouchinterest(hrp, touchPart, 1)
                task.wait(0.5)
                RemoteEvent:FireServer("room_select", SelectedMap, 1)
                task.wait(0.3)
                RemoteEvent:FireServer("room_start")
                break
            end
        end
    end
end

-- ================= WEBHOOK CORE (UPGRADED) =================
local http_request = (syn and syn.request) or (http and http.request) or (fluxus and fluxus.request) or request

pcall(function()
    if isfile("custom_webhook.txt") then
        customWebhook = readfile("custom_webhook.txt"):gsub("%s+", "")
    end
end)

local resultUI = lp.PlayerGui:WaitForChild("battle"):WaitForChild("Result")
local content = resultUI:WaitForChild("Base"):WaitForChild("Content")

local function getTotalBalance()
    local data = lp:FindFirstChild("Data")
    if not data then return "Data not found" end
    local coins = data:FindFirstChild("Coins")
    local gems  = data:FindFirstChild("Gems")
    return string.format("üí∞ **Coins:** %s\nüíé **Gems:** %s", coins and coins.Value or 0, gems and gems.Value or 0)
end

local function getMatchRewards()
    local rewards = {}
    local rewardFolder = content:WaitForChild("Rewards")
    for _, item in ipairs(rewardFolder:GetChildren()) do
        local qty = item:FindFirstChild("Quantity")
        if qty and qty:IsA("TextLabel") and qty.Text ~= "" then
            table.insert(rewards, "‚Ä¢ **" .. item.Name .. "**: " .. qty.Text)
        end
    end
    return #rewards > 0 and table.concat(rewards, "\n") or "No rewards found"
end

local function sendDiscordSafe()
    if customWebhook == "" or not customWebhook:find("http") then return end

    local resultLabel = content:WaitForChild("Result")
    local stageLabel  = content:WaitForChild("Stage")
    
    local isWin = resultLabel.Text:lower():find("win") or resultLabel.Text:lower():find("victory")

    local data = {
        username = "KazeHub Report",
        embeds = {{
            title = (isWin and "üèÜ VICTORY" or "üíÄ DEFEAT") .. " | MATCH RESULT",
            color = isWin and 0x2ecc71 or 0xe74c3c,
            description = "üë§ **Player:** `" .. lp.Name .. "`\n" .. "üó∫ **Stage:** `" .. stageLabel.Text .. "`",
            fields = {
                { name = "üéÅ MATCH REWARDS", value = getMatchRewards(), inline = false },
                { name = "üí∞ TOTAL BALANCE", value = getTotalBalance(), inline = false },
            },
            footer = { text = "KazeHub ‚Ä¢ " .. os.date("%H:%M:%S") },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%S.000Z")
        }}
    }

    pcall(function()
        http_request({
            Url = customWebhook,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(data)
        })
    end)
end

-- ================= WEBHOOK TRIGGER (AUTO CHECK) =================
local hasSent = false
task.spawn(function()
    while true do
        task.wait(1)
        if resultUI and resultUI.Visible == true then
            if not hasSent then
                hasSent = true
                task.wait(2) -- ƒê·ª£i UI load xong text
                sendDiscordSafe()
                print("‚úÖ Webhook Result Sent")
            end
        else
            hasSent = false -- Reset khi b·∫£ng bi·∫øn m·∫•t
        end
    end
end)

-- ================= UI TABS =================
local Main = Window:CreateTab("Lobby / Farm", 4483362458)
local MapDropdown

Main:CreateDropdown({
    Name = "1. Select Mode",
    Options = {"Story","Raid"},
    CurrentOption = {"Story"},
    Callback = function(opt)
        SelectedMode = opt[1]
        if MapDropdown then
            MapDropdown:Refresh(SelectedMode == "Raid" and RaidMaps or getSortedMaps(), true)
        end
    end
})

MapDropdown = Main:CreateDropdown({
    Name = "2. Select Map",
    Options = getSortedMaps(),
    CurrentOption = {},
    Callback = function(opt) SelectedMap = opt[1] end
})

Main:CreateDropdown({
    Name = "3. Select Act",
    Options = {"1","2","3","4","5","6","7","8","9","10"},
    CurrentOption = {"1"},
    Callback = function(opt) SelectedAct = opt[1] end
})

Main:CreateDropdown({
    Name = "4. Difficulty",
    Options = {"Normal","Hard","Nightmare"},
    CurrentOption = {"Normal"},
    Callback = function(opt) SelectedDifficulty = opt[1] end
})

Main:CreateToggle({
    Name = "Auto Join & Start",
    CurrentValue = false,
    Callback = function(val)
        if val then runAutoJoin() end
    end
})

local Tab2 = Window:CreateTab("Webhook", 4483362458)

Tab2:CreateInput({
    Name = "Webhook Link",
    CurrentValue = customWebhook,
    PlaceholderText = "Paste Discord webhook here",
    Callback = function(Text) customWebhook = Text:gsub("%s+", "") end,
})

Tab2:CreateButton({
    Name = "Test & Save Webhook",
    Callback = function()
        if customWebhook ~= "" then
            writefile("custom_webhook.txt", customWebhook)
            local testData = {username = "KazeHub", embeds = {{title = "‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!", color = 0x3498db}}}
            http_request({Url = customWebhook, Method = "POST", Headers = {["Content-Type"]="application/json"}, Body = HttpService:JSONEncode(testData)})
            Rayfield:Notify({Title="Webhook", Content="üíæ ƒê√£ l∆∞u v√† g·ª≠i th·ª≠ th√†nh c√¥ng!", Duration=3})
        end
    end,
})

local MiscTab = Window:CreateTab("Misc", 4483362458)

MiscTab:CreateToggle({
    Name = "Anti-AFK",
    CurrentValue = false,
    Callback = function(Value)
        if Value then
            _G.AntiAFK = lp.Idled:Connect(function()
                VirtualUser:CaptureController()
                VirtualUser:ClickButton2(Vector2.new(0,0))
            end)
        else
            if _G.AntiAFK then _G.AntiAFK:Disconnect() end
        end
    end
})

MiscTab:CreateButton({ Name = "Rejoin", Callback = function() TeleportService:Teleport(game.PlaceId, lp) end })

Rayfield:LoadConfiguration()
print("‚úÖ KazeHub Loaded - Webhook Monitor Active")
