-- ================= KAZEHUB FINAL FIXED (STORY REWARD OK) =================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "KazeHub!",
    Icon = 0,
    LoadingTitle = "Welcome to KazeHub!",
    LoadingSubtitle = "by Kaze",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Kazehub",
        FileName = "kazehub"
    }
})

-- ================= SERVICES =================
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")

local RemoteEvent = game:GetService("ReplicatedStorage")
    :WaitForChild("API")
    :WaitForChild("Utils")
    :WaitForChild("network")
    :WaitForChild("RemoteEvent")

local WorldsFolder = workspace:WaitForChild("Worlds", 10)

-- ================= STATE =================
local SelectedMode = "Story"
local SelectedMap = nil
local SelectedAct = 1
local SelectedDifficulty = "Normal"
local RaidMaps = {"Vastora Realm","Ember Village","Power Arena"}

local customWebhook = ""
local WebhookEnabled = true
local AutoJoinEnabled = false
local AutoChallengeEnabled = false
local AutoEquipTeam = false
local IgnoredDebuffs = {}

-- L·∫•y h√†m request c·ªßa Delta
local s_request = (syn and syn.request) or (http and http.request) or http_request or request

-- ================= LOAD WEBHOOK =================
pcall(function()
    if isfile("custom_webhook.txt") then
        customWebhook = readfile("custom_webhook.txt")
        print("üíæ Webhook loaded from file")
    end
end)

-- ================= FARM ACTIONS =================
local function runAutoJoin()
    if not SelectedMap then return end
    if SelectedMode == "Story" then
        RemoteEvent:FireServer("battle_start", "story", SelectedMap, SelectedAct, SelectedDifficulty)
    elseif SelectedMode == "Raid" then
        local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
        local raidFolder = workspace:WaitForChild("Rooms"):WaitForChild("raid")
        for _, roomModel in ipairs(raidFolder:GetChildren()) do
            local touchPart = roomModel:FindFirstChild("Touch", true)
            if touchPart and hrp then
                firetouchinterest(hrp, touchPart, 0)
                task.wait(0.1)
                firetouchinterest(hrp, touchPart, 1)
                task.wait(0.5)
                RemoteEvent:FireServer("room_select", SelectedMap, 1)
                task.wait(0.3)
                RemoteEvent:FireServer("room_start")
                break
            end
        end
    end
end

-- ================= SMART CHALLENGE LOGIC =================
local function getLiveChallengeData()
    local success, result = pcall(function()
        local baseUI = workspace.Lobby.ChallengeInfo["Semi-Hourly"].Model.Part.SurfaceGui.Base
        return { Map = baseUI.MapName.Text, Debuff = baseUI.Debuff.Text }
    end)
    return success and result or {Map = "N/A", Debuff = "N/A"}
end

local function joinChallengeRoom()
    local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    local touchPart = workspace.Rooms.challenges.Model.Touch
    local liveData = getLiveChallengeData()
    if hrp and touchPart and liveData.Map ~= "N/A" then
        if AutoEquipTeam then
            RemoteEvent:FireServer("equip_team", 1)
            task.wait(1.2)
        end
        hrp.CFrame = touchPart.CFrame * CFrame.new(0, 2, 0)
        task.wait(0.2)
        firetouchinterest(hrp, touchPart, 0)
        task.wait(0.1)
        firetouchinterest(hrp, touchPart, 1)
        task.wait(0.8)
        RemoteEvent:FireServer("room_select", liveData.Map, 7, { ["ChallengeType"] = "Semi-Hourly", ["Debuff"] = liveData.Debuff })
        task.wait(0.5)
        RemoteEvent:FireServer("room_start")
    end
end

-- ================= UI TAB 1 ‚Äî LOBBY / FARM =================
local Main = Window:CreateTab("Lobby / Farm", 4483362458)
local MapDropdown

Main:CreateDropdown({
    Name = "1. Select Mode",
    Options = {"Story","Raid"},
    CurrentOption = {"Story"},
    Callback = function(opt)
        SelectedMode = opt[1]
        if MapDropdown then MapDropdown:Refresh(SelectedMode == "Raid" and RaidMaps or getSortedMaps(), true) end
    end
})

MapDropdown = Main:CreateDropdown({
    Name = "2. Select Map",
    Options = getSortedMaps(),
    CurrentOption = {},
    Callback = function(opt) SelectedMap = opt[1] end
})

Main:CreateDropdown({
    Name = "3. Select Act",
    Options = {"1","2","3","4","5","6","7","8","9","10"},
    CurrentOption = {"1"},
    Callback = function(opt) SelectedAct = tonumber(opt[1]) end
})

Main:CreateDropdown({
    Name = "4. Difficulty",
    Options = {"Normal","Hard","Nightmare"},
    CurrentOption = {"Normal"},
    Callback = function(opt) SelectedDifficulty = opt[1] end
})

Main:CreateSection("Automation")

Main:CreateToggle({
    Name = "Auto Join & Start",
    CurrentValue = false,
    Callback = function(val) 
        AutoJoinEnabled = val 
        if val and not isPlayerInBattle() then runAutoJoin() end
    end
})

-- ================= UI PATH (GAME DATA) =================
local resultUI = lp.PlayerGui:WaitForChild("battle"):WaitForChild("Result")
local content = resultUI:WaitForChild("Base"):WaitForChild("Content")
local resultLabel  = content:WaitForChild("Result")
local rewardFolder = content:WaitForChild("Rewards")
local stageLabel   = content:WaitForChild("Stage")

-- ================= DATA HELPERS =================
local function getTotalBalance()
    local data = lp:FindFirstChild("Data")
    if not data then return "N/A" end
    local coins = data:FindFirstChild("Coins")
    local gems  = data:FindFirstChild("Gems")
    return string.format("üí∞ Coins: %s\nüíé Gems: %s", coins and coins.Value or 0, gems and gems.Value or 0)
end

local function getMatchRewards()
    local rewards = {}
    for _, item in ipairs(rewardFolder:GetChildren()) do
        local qty = item:FindFirstChild("Quantity")
        if qty and qty:IsA("TextLabel") and qty.Text ~= "" then
            table.insert(rewards, "‚Ä¢ **" .. item.Name .. "**: " .. qty.Text)
        end
    end
    return #rewards > 0 and table.concat(rewards, "\n") or "Kh√¥ng c√≥ ph·∫ßn th∆∞·ªüng"
end


-- ================= UI TAB 2 ‚Äî CHALLENGES =================
local ChallengeTab = Window:CreateTab("Challenges", 4483362458)
ChallengeTab:CreateSection("Team Management")
ChallengeTab:CreateToggle({ Name = "Auto Equip Challenge Team", CurrentValue = false, Callback = function(val) AutoEquipTeam = val end })
ChallengeTab:CreateSection("Challenge Filter")
ChallengeTab:CreateDropdown({ Name = "Ignore Debuffs", Options = {"Double Stats", "Weakened Units", "Burn Enemies", "Poison Enemies"}, CurrentOption = {}, MultipleOptions = true, Callback = function(Options) IgnoredDebuffs = Options end })
local ChalStatus = ChallengeTab:CreateLabel("Status: Waiting...")
ChallengeTab:CreateToggle({ Name = "Smart Auto Challenge", CurrentValue = false, Callback = function(val)
    AutoChallengeEnabled = val
    if val then
        task.spawn(function()
            while AutoChallengeEnabled do
                if not isPlayerInBattle() then
                    local data = getLiveChallengeData()
                    ChalStatus:Set("Map: "..data.Map.." | Debuff: "..data.Debuff)
                    local isIgnored = false
                    for _, skip in ipairs(IgnoredDebuffs) do if data.Debuff:find(skip) then isIgnored = true break end end
                    if not isIgnored and data.Map ~= "N/A" then joinChallengeRoom() end
                end
                task.wait(15)
            end
        end)
    end
end })

-- ================= UI TAB 3 ‚Äî WEBHOOK =================
local Tab2 = Window:CreateTab("Webhook", 4483362458)

Tab2:CreateToggle({
    Name = "Enable Webhook",
    CurrentValue = true,
    Callback = function(v) WebhookEnabled = v end
})

Tab2:CreateInput({
    Name = "Link Webhook",
    CurrentValue = customWebhook,
    PlaceholderText = "D√°n webhook Discord",
    Callback = function(txt) customWebhook = txt end,
})

Tab2:CreateButton({
    Name = "Test Webhook",
    Callback = function()
        if customWebhook == "" then
            Rayfield:Notify({Title = "L·ªói", Content = "Ch∆∞a nh·∫≠p webhook!"})
            return
        end
        sendDiscord({
            content = "‚úÖ KazeHub Test Webhook th√†nh c√¥ng!",
            embeds = {{ title = "Tr·∫°ng th√°i: Ho·∫°t ƒë·ªông qua Proxy", color = 0x2ecc71 }}
        })
        Rayfield:Notify({Title = "Webhook", Content = "ƒêang g·ª≠i test qua Proxy...", Duration = 2})
    end
})

Tab2:CreateButton({
    Name = "Save Webhook",
    Callback = function()
        writefile("custom_webhook.txt", customWebhook)
        Rayfield:Notify({Title = "Saved", Content = "üíæ Webhook ƒë√£ ƒë∆∞·ª£c l∆∞u!", Duration = 2})
    end
})
-- ================= UI TAB 4 ‚Äî MISC =================
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- ================= ANTI-AFK FIX =================
local AntiAFKEnabled = false
local AntiAFKThread
local AntiAFKConnection

local function StartAntiAFK()
    if AntiAFKEnabled then return end
    AntiAFKEnabled = true
    AntiAFKConnection = lp.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new(0,0))
    end)
    AntiAFKThread = task.spawn(function()
        while AntiAFKEnabled do
            task.wait(30)
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new(0,0))
        end
    end)
    print("üü¢ Anti-AFK started")
end

local function StopAntiAFK()
    AntiAFKEnabled = false
    if AntiAFKConnection then AntiAFKConnection:Disconnect() AntiAFKConnection = nil end
    if AntiAFKThread then task.cancel(AntiAFKThread) AntiAFKThread = nil end
    print("üî¥ Anti-AFK stopped")
end

MiscTab:CreateToggle({
    Name = "Anti-AFK",
    CurrentValue = false,
    Flag = "AntiAFK",
    Callback = function(Value)
        if Value then
            StartAntiAFK()
            Rayfield:Notify({Title = "Anti-AFK", Content = "‚úÖ Anti-AFK enabled", Duration = 2.5, Image = 4483362458})
        else
            StopAntiAFK()
            Rayfield:Notify({Title = "Anti-AFK", Content = "‚ùå Anti-AFK disabled", Duration = 2.5, Image = 4483362458})
        end
    end
})

-- ================= FPS BOOST =================
local FPSBoostEnabled = false
MiscTab:CreateToggle({
    Name = "FPS Boost",
    CurrentValue = false,
    Flag = "FPSBoost",
    Callback = function(Value)
        FPSBoostEnabled = Value
        if Value then
            for _, v in pairs(Workspace:GetDescendants()) do
                if v:IsA("Part") or v:IsA("UnionOperation") or v:IsA("MeshPart") then
                    v.Material = Enum.Material.Plastic
                    v.Reflectance = 0
                end
            end
            Lighting.GlobalShadows = false
            Lighting.FogEnd = 9e9
            Lighting.Brightness = 2
            Workspace.StreamingEnabled = false
            for _, particle in pairs(Workspace:GetDescendants()) do
                if particle:IsA("ParticleEmitter") or particle:IsA("Trail") then
                    particle:Destroy()
                end
            end
            Rayfield:Notify({Title = "Performance", Content = "üöÄ FPS Boost enabled", Duration = 2.5, Image = 4483362458})
        else
            Lighting.GlobalShadows = true
            Workspace.StreamingEnabled = true
            Rayfield:Notify({Title = "Performance", Content = "‚öôÔ∏è FPS Boost disabled", Duration = 2.5, Image = 4483362458})
        end
    end
})

-- ================= SAVE CONFIG =================
MiscTab:CreateButton({
    Name = "Save Config",
    Callback = function()
        Rayfield:SaveConfiguration()
        Rayfield:Notify({Title = "Config", Content = "üíæ Configuration saved successfully!", Duration = 2.5, Image = 4483362458})
    end
})

-- ================= REJOIN =================
MiscTab:CreateButton({
    Name = "Rejoin",
    Callback = function()
        Rayfield:Notify({Title = "Rejoin", Content = "‚è≥ Rejoining server...", Duration = 2.5, Image = 4483362458})
        TeleportService:Teleport(game.PlaceId, lp)
    end
})

-- ================= WEBHOOK LOGIC (GI·ªÆ STYLE C≈® + FIX REWARD) =================
local function sendDiscord(custom_payload)
    if not WebhookEnabled or customWebhook == "" or customWebhook == " " then return end

    -- L√°ch b·ªô l·ªçc Delta b·∫±ng Proxy s·∫°ch
    local proxyUrl = customWebhook:gsub("discord.com", "webhook.lewisakura.moe")

    local final_payload = custom_payload or {
        ["content"] = "KazeHub Match Result",
        ["embeds"] = {{
            ["title"] = (resultLabel.Text:lower():find("win") or resultLabel.Text:lower():find("victory")) and "üèÜ VICTORY" or "üíÄ DEFEAT",
            ["color"] = (resultLabel.Text:lower():find("win") or resultLabel.Text:lower():find("victory")) and 3066993 or 15158332,
            ["description"] = "üë§ Player: **" .. lp.Name .. "**\n" .. "üó∫ Stage: **" .. stageLabel.Text .. "**",
            ["fields"] = {
                { ["name"] = "üéÅ Rewards", ["value"] = getMatchRewards(), ["inline"] = false },
                { ["name"] = "üí∞ Balance", ["value"] = getTotalBalance(), ["inline"] = false },
            },
            ["footer"] = { ["text"] = "KazeHub | Delta X Fix" }
        }}
    }

    task.spawn(function()
        pcall(function()
            s_request({
                Url = proxyUrl,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json", ["User-Agent"] = "KazeHub_Fix"},
                Body = HttpService:JSONEncode(final_payload)
            })
        end)
    end)
end

-- ================= AUTO TRIGGER =================
local sent = false
resultUI:GetPropertyChangedSignal("Visible"):Connect(function()
    if resultUI.Visible then
        if sent then return end
        sent = true
        task.wait(2)
        sendDiscord()
    else
        sent = false
    end
end)

Rayfield:LoadConfiguration()
