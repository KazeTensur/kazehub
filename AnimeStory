-- ================= KAZEHUB CLEAN FINAL + BEAUTY UI =================
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

local Window = Rayfield:CreateWindow({
    Name = "‚ú® KazeHub!",
    Icon = 0,
    LoadingTitle = "Welcome to KazeHub!",
    LoadingSubtitle = "by Kaze",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Kazehub",
        FileName = "kazehub"
    }
})

-- ================= SERVICES =================
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

local RemoteEvent = game:GetService("ReplicatedStorage")
    :WaitForChild("API")
    :WaitForChild("Utils")
    :WaitForChild("network")
    :WaitForChild("RemoteEvent")

local WorldsFolder = workspace:WaitForChild("Worlds", 10)

local s_request
pcall(function() s_request = http_request end)
pcall(function() if not s_request then s_request = request end end)
pcall(function() if not s_request and http then s_request = http.request end end)

-- ================= STATE =================
local SelectedMode = "Story"
local SelectedMap = nil
local SelectedAct = "1"
local SelectedDifficulty = "Normal"
local RaidMaps = {"Vastora Realm","Ember Village","Power Arena"}
local WebhookEnabled = true
local customWebhook = ""

-- ================= LOAD WEBHOOK =================
pcall(function()
    if isfile("custom_webhook.txt") then
        customWebhook = readfile("custom_webhook.txt")
    end
end)

-- ================= HELPERS =================
local function getSortedMaps()
    local list = {}
    if WorldsFolder then
        for _, m in ipairs(WorldsFolder:GetChildren()) do
            table.insert(list, m.Name)
        end
        table.sort(list)
    else
        list = {"Map Not Found"}
    end
    return list
end

local function isPlayerInBattle()
    local gui = lp.PlayerGui:FindFirstChild("battle")
    return gui and gui.Enabled
end

--// CODES
local function getActiveCodes()
    local codes = {}
    local codesPath = game:GetService("ReplicatedStorage"):WaitForChild("API", 5):WaitForChild("codes", 5)

    local success, codeModule = pcall(function() 
        return require(codesPath) 
    end)

    if success and codeModule and codeModule.Codes then
        local currentTime = os.time()
        for codeName, data in pairs(codeModule.Codes) do
            if data.Expires and data.Expires > currentTime then
                table.insert(codes, codeName)
            end
        end
    else
        codes = {"2026", "portals", "vampire", "happyholidays", "christmaspresent"}
    end
    return codes
end

-- ================= UI PATH (RESULT UI) =================
local resultUI = lp.PlayerGui:WaitForChild("battle", 10) and lp.PlayerGui.battle:WaitForChild("Result", 10)

-- ================= WEBHOOK CORE =================
local function getMatchRewards(rewardFolder)
    local rewards = {}
    if rewardFolder then
        for _, item in ipairs(rewardFolder:GetChildren()) do
            local qty = item:FindFirstChild("Quantity")
            if qty and qty:IsA("TextLabel") and qty.Text ~= "" then
                table.insert(rewards, "‚Ä¢ **" .. item.Name .. "**: " .. qty.Text)
            end
        end
    end
    return #rewards > 0 and table.concat(rewards, "\n") or "Kh√¥ng c√≥ ph·∫ßn th∆∞·ªüng"
end

local function sendResultWebhook()
    if not WebhookEnabled then return end
    if customWebhook == "" or customWebhook == " " then return end
    if type(s_request) ~= "function" then return end

    local currentResultUI = lp.PlayerGui:FindFirstChild("battle") and lp.PlayerGui.battle:FindFirstChild("Result")
    if not currentResultUI then return end

    local content = currentResultUI:FindFirstChild("Base") and currentResultUI.Base:FindFirstChild("Content")
    if not content then return end

    local resultLabel  = content:FindFirstChild("Result")
    local rewardFolder = content:FindFirstChild("Rewards")
    local stageLabel   = content:FindFirstChild("Stage")

    local data = lp:FindFirstChild("Data")
    local coins = data and data:FindFirstChild("Coins")
    local gems  = data and data:FindFirstChild("Gems")
    local balanceText = string.format("üí∞ Coins: %s\nüíé Gems: %s", coins and coins.Value or 0, gems and gems.Value or 0)

    local itemsFolder = lp.PlayerGui:FindFirstChild("main") 
                        and lp.PlayerGui.main:FindFirstChild("Inventory") 
                        and lp.PlayerGui.main.Inventory:FindFirstChild("Base") 
                        and lp.PlayerGui.main.Inventory.Base:FindFirstChild("Content") 
                        and lp.PlayerGui.main.Inventory.Base.Content:FindFirstChild("Items")

    local traitText = ""
    if itemsFolder then
        local traitTokens = itemsFolder:FindFirstChild("Trait Tokens")
        local ice = itemsFolder:FindFirstChild("Ice")
        local stocking = itemsFolder:FindFirstChild("Christmas Stocking")

        local traitQty = traitTokens and traitTokens:FindFirstChild("Quantity") and traitTokens.Quantity.Text or "0"
        local iceQty = ice and ice:FindFirstChild("Quantity") and ice.Quantity.Text or "0"
        local stockQty = stocking and stocking:FindFirstChild("Quantity") and stocking.Quantity.Text or "0"

        traitText = string.format("üéØ Trait Tokens: %s\n‚ùÑÔ∏è Ice: %s\nüéÅ Christmas Stocking: %s", traitQty, iceQty, stockQty)
    else
        traitText = "üéØ Trait Tokens: 0\n‚ùÑÔ∏è Ice: 0\nüéÅ Christmas Stocking: 0"
    end

    local rewardText = getMatchRewards(rewardFolder)

    local proxyUrl = customWebhook:gsub("discord.com", "webhook.lewisakura.moe")

    local isWin = resultLabel and (resultLabel.Text:lower():find("win") or resultLabel.Text:lower():find("victory"))

    local payload = {
        content = "KazeHub Match Result",
        embeds = {{
            title = isWin and "üèÜ VICTORY" or "üíÄ DEFEAT",
            color = isWin and 3066993 or 15158332,
            description =
                "üë§ Player: **"..lp.Name.."**\n"..
                "üó∫ Stage: **"..(stageLabel and stageLabel.Text or "Unknown").."**",
            fields = {
                {name = "üéÅ Rewards", value = rewardText, inline = false},
                {name = "üí∞ Balance", value = balanceText, inline = false},
                {name = "üõ†Ô∏è Items", value = traitText, inline = false}
            },
            footer = { text = "‚ú® KazeHub | Delta X Safe" }
        }}
    }

    task.spawn(function()
        pcall(function()
            s_request({
                Url = proxyUrl,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(payload)
            })
        end)
    end)
end

-- ================= RESULT UI TRIGGER =================
if resultUI then
    local sent = false
    resultUI:GetPropertyChangedSignal("Visible"):Connect(function()
        if resultUI.Visible then
            if sent then return end
            sent = true
            task.wait(2)
            sendResultWebhook()
            print("üì® Webhook sent via Result UI")
        else
            sent = false
        end
    end)
end

-- ================= MAIN TAB =================
local Main = Window:CreateTab("üó∫ Lobby / Farm", 4483362458)

Main:CreateLabel("üåü Mode / Map Selection")
local MapDropdown

local function refreshMapByMode(mode)
    if not MapDropdown then return end

    if mode == "Raid" then
        MapDropdown:Refresh(RaidMaps, true)
        SelectedMap = RaidMaps[1]
        MapDropdown:Set({RaidMaps[1]})
    else
        local maps = getSortedMaps()
        MapDropdown:Refresh(maps, true)
        SelectedMap = maps[1]
        MapDropdown:Set({maps[1]})
    end
end

-- !!! ƒê√É S·ª¨A L·ªñI: ƒê√≥ng ngo·∫∑c ch√≠nh x√°c cho CreateDropdown
Main:CreateDropdown({
    Name = "Select Mode üåü",
    Options = {"Story","Raid"},
    CurrentOption = {"Story"},
    Flag = "Mode",
    Callback = function(opt)
        SelectedMode = opt[1]
        refreshMapByMode(SelectedMode)
    end
})

MapDropdown = Main:CreateDropdown({
    Name = "Select Map üó∫Ô∏è",
    Options = getSortedMaps(),
    CurrentOption = {},
    Flag = "Map",
    Callback = function(opt)
        SelectedMap = opt[1]
    end
})

-- G·ªçi refresh l·∫ßn ƒë·∫ßu
refreshMapByMode(SelectedMode)

Main:CreateDropdown({
    Name = "Select Act üî¢",
    Options = {"1","2","3","4","5","6","7","8","9","10"},
    CurrentOption = {"1"},
    Flag = "Act",
    Callback = function(opt) SelectedAct = opt[1] end
})

Main:CreateDropdown({
    Name = "Difficulty ‚öîÔ∏è",
    Options = {"Normal","Hard","Nightmare"},
    CurrentOption = {"Normal"},
    Flag = "Difficulty",
    Callback = function(opt) SelectedDifficulty = opt[1] end
})

Main:CreateToggle({
Name = "Auto Join & Start üöÄ",
CurrentValue = false,
Flag = "AutoJoinStart",
Callback = function(v)
    if not v then return end

    task.spawn(function()
        -- N·∫øu ƒëang trong battle th√¨ h·ªßy
        if isPlayerInBattle() then
            Rayfield.Flags["AutoJoinStart"]:Set(false)
            return
        end

        -- ================= STORY (JOIN 1 L·∫¶N) =================
        if SelectedMode == "Story" then
            RemoteEvent:FireServer(
                "battle_start",
                "story",
                SelectedMap,
                tonumber(SelectedAct),
                SelectedDifficulty
            )

            task.wait(1)
            Rayfield.Flags["AutoJoinStart"]:Set(false)

            Rayfield:Notify({
                Title = "Story Joined",
                Content = "ƒê√£ v√†o Story 1 l·∫ßn ‚Äì Auto Join ƒë√£ t·∫Øt",
                Duration = 2
            })
            return
        end

        -- ================= RAID (JOIN 1 L·∫¶N) =================
        if SelectedMode == "Raid" then
            local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then
                Rayfield.Flags["AutoJoinStart"]:Set(false)
                return
            end

            local raidFolder = workspace:WaitForChild("Rooms"):WaitForChild("raid")
            for _, room in ipairs(raidFolder:GetChildren()) do
                local touch = room:FindFirstChild("Touch", true)
                if touch then
                    firetouchinterest(hrp, touch, 0)
                    task.wait(0.1)
                    firetouchinterest(hrp, touch, 1)

                    task.wait(0.4)
                    RemoteEvent:FireServer(
                        "room_select",
                        SelectedMap,
                        tonumber(SelectedAct)
                    )

                    task.wait(0.3)
                    RemoteEvent:FireServer("room_start")

                    task.wait(1)
                    Rayfield.Flags["AutoJoinStart"]:Set(false)

                    Rayfield:Notify({
                        Title = "Raid Joined",
                        Content = "ƒê√£ v√†o Raid 1 l·∫ßn ‚Äì Auto Join ƒë√£ t·∫Øt",
                        Duration = 2
                    })
                    break
                end
            end
        end
    end)
end
})


-- ================= CHALLENGE TAB =================
local ChallengeTab = Window:CreateTab("üß† Challenges", 4483362458)
ChallengeTab:CreateLabel("‚ö†Ô∏è Requires saved team in SLOT 1")

local AutoChallengeEnabled = false
local AutoEquipTeam = false
local IgnoredDebuffs = {}

ChallengeTab:CreateToggle({
    Name = "Auto Equip Team (Slot 1) üõ°Ô∏è",
    CurrentValue = false,
    Flag = "AutoEquipTeam",
    Callback = function(v) AutoEquipTeam = v end
})
ChallengeTab:CreateDropdown({
    Name = "Ignore Debuffs ‚ùå",
    Options = {"Double Stats","Weakened Units","Burn Enemies","Poison Enemies"},
    MultipleOptions = true,
    CurrentOption = {},
    Flag = "IgnoredDebuffs",
    Callback = function(opts) IgnoredDebuffs = opts end
})
local StatusLabel = ChallengeTab:CreateLabel("üîπ Status: Waiting...")

-- ================= SMART AUTO CHALLENGE CORE =================

local function getLiveChallengeData()
    local ok, data = pcall(function()
        local ui = workspace.Lobby.ChallengeInfo["Semi-Hourly"].Model.Part.SurfaceGui.Base
        return {
            Map = ui.MapName.Text,
            Debuff = ui.Debuff.Text
        }
    end)
    return ok and data or {Map = "N/A", Debuff = "N/A"}
end

local function joinChallenge()
    local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    local touch = workspace.Rooms:FindFirstChild("challenges") and workspace.Rooms.challenges.Model:FindFirstChild("Touch")
    local data = getLiveChallengeData()

    if not hrp or not touch or data.Map == "N/A" then return end

    -- Check ignored debuffs
    for _, skip in ipairs(IgnoredDebuffs) do
        if data.Debuff:lower():find(skip:lower()) then
            StatusLabel:Set("‚õî Skipped Debuff: " .. data.Debuff)
            return
        end
    end

    -- Auto equip team slot 1
    if AutoEquipTeam then
        RemoteEvent:FireServer("equip_team", 1)
        task.wait(1)
    end

    -- Touch challenge door
    hrp.CFrame = touch.CFrame * CFrame.new(0, 2, 0)
    firetouchinterest(hrp, touch, 0)
    firetouchinterest(hrp, touch, 1)

    task.wait(0.6)

    -- Select room
    RemoteEvent:FireServer(
        "room_select",
        data.Map,
        7,
        {ChallengeType = "Semi-Hourly", Debuff = data.Debuff}
    )

    task.wait(0.3)
    RemoteEvent:FireServer("room_start")

    StatusLabel:Set("‚úÖ Joined: " .. data.Map)
end

ChallengeTab:CreateToggle({
    Name = "Smart Auto Challenge ü§ñ",
    CurrentValue = false,
    Flag = "AutoChallenge",
    Callback = function(v)
        AutoChallengeEnabled = v
        if v then
            task.spawn(function()
                while AutoChallengeEnabled do
                    if not isPlayerInBattle() then
                        local d = getLiveChallengeData()
                        StatusLabel:Set("üó∫ " .. d.Map .. " | ‚ö†Ô∏è " .. d.Debuff)
                        joinChallenge()
                    end
                    task.wait(15)
                    if not AutoChallengeEnabled then break end
                end
            end)
        end
    end
})

-- ================= GAMEPLAY TAB =================
local GameplayTab = Window:CreateTab("üé∞ Gameplay", 4483362458)
GameplayTab:CreateLabel("üéØ Summon / Spinner Settings")
local SelectedGameplay = "x10 Summon Banner"
local AutoSpinEnabled = false
local SpinDelay = 1.5

GameplayTab:CreateDropdown({
    Name = "Select Action üé≤",
    Options = {"x10 Summon Banner","Christmas Standard Spin","Christmas Advanced Spin"},
    CurrentOption = {"x10 Summon Banner"},
    MultipleOptions = false,
    Flag = "GameplayAction",
    Callback = function(opt) SelectedGameplay = opt[1] end
})

GameplayTab:CreateInput({
    Name = "Spin Delay ‚è±Ô∏è (seconds)",
    PlaceholderText = "VD: 1.5 (0.3-60)",
    CurrentValue = tostring(SpinDelay),
    RemoveTextAfterFocusLost = false,
    Callback = function(txt)
        local v = tonumber(txt)
        if v and v > 0 then SpinDelay = math.clamp(v,0.3,60)
        else Rayfield:Notify({Title="Invalid Delay",Content="Delay ph·∫£i >0",Duration=2}) end
    end
})

local function doGameplayAction()
    if SelectedGameplay == "x10 Summon Banner" then
        RemoteEvent:FireServer("summon_roll", "Standard", 10)

    elseif SelectedGameplay == "Christmas Standard Spin" then
        RemoteEvent:FireServer("spinner_standard")

    elseif SelectedGameplay == "Christmas Advanced Spin" then
        RemoteEvent:FireServer("spinner_advanced")
    end
end

GameplayTab:CreateToggle({
    Name = "Auto Spin / Summon üîÑ",
    CurrentValue = false,
    Flag = "AutoGameplay",
    Callback = function(v)
        AutoSpinEnabled = v
        if v then
            task.spawn(function()
                while AutoSpinEnabled do
                    doGameplayAction()
                    task.wait(SpinDelay)
                    if not AutoSpinEnabled then break end
                end
            end)
        end
    end
})


-- ================= AUTO REDEEM CODE (SMART) =================
GameplayTab:CreateLabel("üéÅ Smart Giftcodes")

GameplayTab:CreateButton({
    Name = "Redeem All Active Codes üé´",
    Callback = function()
        local activeCodes = getActiveCodes()
        for _, code in ipairs(activeCodes) do
            task.spawn(function()
                RemoteEvent:FireServer("codes", code)
            end)
            task.wait(0.5)
        end
        Rayfield:Notify({
            Title = "Success",
            Content = "ƒê√£ qu√©t v√† nh·∫≠p " .. #activeCodes .. " code c√≤n h·∫°n!",
            Duration = 3
        })
    end
})

local AutoRedeemLoop = false
GameplayTab:CreateToggle({
    Name = "Auto Update & Redeem üîÅ",
    CurrentValue = false,
    Flag = "AutoRedeemSmart",
    Callback = function(v)
        AutoRedeemLoop = v
        if v then
            task.spawn(function()
                while AutoRedeemLoop do
                    local activeCodes = getActiveCodes()
                    for _, code in ipairs(activeCodes) do
                        if not AutoRedeemLoop then break end
                        RemoteEvent:FireServer("codes", code)
                        task.wait(1)
                    end
                    -- ƒê·ª£i 10 ph√∫t qu√©t l·∫°i m·ªôt l·∫ßn xem game c√≥ update code m·ªõi kh√¥ng
                    task.wait(600)
                end
            end)
        end
    end
})

-- ================= WEBHOOK TAB =================
local WebTab = Window:CreateTab("üîó Webhook", 4483362458)
WebTab:CreateToggle({Name="Enable Webhook ‚úÖ", CurrentValue=true, Flag="WebhookEnable", Callback=function(v) WebhookEnabled=v end})
WebTab:CreateInput({Name="Webhook URL üîó", CurrentValue=customWebhook, PlaceholderText="Paste Discord webhook", Callback=function(txt) customWebhook=txt end})
WebTab:CreateButton({Name="üíæ Save Webhook", Callback=function() writefile("custom_webhook.txt",customWebhook) Rayfield:Notify({Title="Saved",Content="Webhook saved",Duration=2}) end})
WebTab:CreateButton({Name="‚úÖ Test Webhook", Callback=function()
    if customWebhook=="" then Rayfield:Notify({Title="Webhook Error",Content="Webhook URL tr·ªëng",Duration=2}) return end
    if type(s_request)~="function" then Rayfield:Notify({Title="HTTP Error",Content="Executor kh√¥ng h·ªó tr·ª£ HTTP Request",Duration=3}) return end
    local testEmbed={title="‚úÖ KazeHub Webhook Test", description="Webhook ho·∫°t ƒë·ªông th√†nh c√¥ng!\n\nüë§ Player: **"..lp.Name.."**\n‚è± Time: "..DateTime.now():FormatLocalTime("LLL","en-us"), color=3447003, footer={text="KazeHub Test"}}
    local ok,err=pcall(function() s_request({Url=customWebhook, Method="POST", Headers={["Content-Type"]="application/json"}, Body=HttpService:JSONEncode({username="KazeHub",embeds={testEmbed}})}) end)
    Rayfield:Notify({Title=ok and "Success" or "Failed", Content=ok and "Test webhook sent!" or tostring(err), Duration=2})
end})

-- ================= FPS BOOST 2 (ADVANCED) =================

local FPS2_Original = {
    Lighting = {},
    Materials = {}
}

local function enableFPSBoost2()
    -- Lighting c·ª±c th·∫•p
    FPS2_Original.Lighting.GlobalShadows = Lighting.GlobalShadows
    FPS2_Original.Lighting.Brightness = Lighting.Brightness
    FPS2_Original.Lighting.FogEnd = Lighting.FogEnd

    Lighting.GlobalShadows = false
    Lighting.Brightness = 0
    Lighting.FogEnd = 9e9

    -- Remove post effects
    for _, v in ipairs(Lighting:GetChildren()) do
        if v:IsA("PostEffect") then
            v.Enabled = false
        end
    end

    -- Workspace optimizations
    for _, obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") then
            FPS2_Original.Materials[obj] = obj.Material
            obj.Material = Enum.Material.Plastic
            obj.Reflectance = 0

        elseif obj:IsA("Decal") or obj:IsA("Texture") then
            obj.Transparency = 1

        elseif obj:IsA("ParticleEmitter")
            or obj:IsA("Trail")
            or obj:IsA("Beam") then
            obj.Enabled = false
        end
    end

    -- Terrain
    local terrain = Workspace:FindFirstChildOfClass("Terrain")
    if terrain then
        terrain.WaterWaveSize = 0
        terrain.WaterWaveSpeed = 0
        terrain.WaterReflectance = 0
        terrain.WaterTransparency = 1
    end

    -- Rendering quality
    settings().Rendering.QualityLevel = 1
end

local function disableFPSBoost2()
    -- Restore lighting
    for k, v in pairs(FPS2_Original.Lighting) do
        Lighting[k] = v
    end

    -- Restore materials
    for obj, mat in pairs(FPS2_Original.Materials) do
        if obj and obj:IsA("BasePart") then
            obj.Material = mat
        end
    end
end


-- ================= MISC TAB =================
local Misc = Window:CreateTab("‚öôÔ∏è Misc", 4483362458)
Misc:CreateLabel("‚ö° Performance Settings")
Misc:CreateToggle({Name="FPS Boost üöÄ", CurrentValue=false, Flag="FPSBoost", Callback=function(v)
    if v then
        settings().Rendering.QualityLevel = 1
        Lighting.GlobalShadows = false
        for _,obj in ipairs(Workspace:GetDescendants()) do
            if obj:IsA("BasePart") then obj.Material=Enum.Material.Plastic obj.Reflectance=0 end
        end
    end
end})
Misc:CreateToggle({
    Name = "FPS Boost 2 (Advanced) üî•",
    CurrentValue = false,
    Flag = "FPSBoost2",
    Callback = function(v)
        if v then
            enableFPSBoost2()
            Rayfield:Notify({
                Title = "FPS Boost 2",
                Content = "ƒê√£ b·∫≠t FPS Boost cao c·∫•p üöÄ",
                Duration = 2
            })
        else
            disableFPSBoost2()
            Rayfield:Notify({
                Title = "FPS Boost 2",
                Content = "ƒê√£ t·∫Øt FPS Boost 2",
                Duration = 2
            })
        end
    end
})

Misc:CreateLabel("üõ°Ô∏è Utility")
Misc:CreateToggle({Name="Anti-AFK üí§", CurrentValue=false, Flag="AntiAFK", Callback=function(v)
    if v then 
        _G.AFK = lp.Idled:Connect(function() 
            VirtualUser:CaptureController() 
            VirtualUser:ClickButton2(Vector2.new(0,0)) 
        end)
    else 
        if _G.AFK then _G.AFK:Disconnect() end 
    end
end})
Misc:CreateButton({Name="üíæ Save Config Now", Callback=function() Rayfield:SaveConfiguration() Rayfield:Notify({Title="Config",Content="Saved successfully",Duration=2}) end})
Misc:CreateButton({Name="üîÑ Rejoin", Callback=function() TeleportService:Teleport(game.PlaceId,lp) end})

Rayfield:LoadConfiguration()
print("‚úÖ KAZEHUB BEAUTY UI LOADED")
