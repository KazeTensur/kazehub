-- ================= KAZEHUB COMPLETE + WEBHOOK FIXED =================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "KazeHub!",
    Icon = 0,
    LoadingTitle = "Welcome to KazeHub!",
    LoadingSubtitle = "by Kaze",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "Kazehub",
        FileName = "kazehub"
    }
})

-- ================= SERVICES =================
local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local RemoteEvent = game:GetService("ReplicatedStorage")
    :WaitForChild("API")
    :WaitForChild("Utils")
    :WaitForChild("network")
    :WaitForChild("RemoteEvent")

local WorldsFolder = workspace:WaitForChild("Worlds", 10)
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

-- ================= STATE =================
local SelectedMode = "Story"
local SelectedMap = nil
local SelectedAct = "1"
local SelectedDifficulty = "Normal"
local RaidMaps = {"Vastora Realm","Ember Village","Power Arena"}
local customWebhook = ""

-- ================= FUNCTIONS =================
local function getSortedMaps()
    local list = {}
    if WorldsFolder then
        for _, map in ipairs(WorldsFolder:GetChildren()) do
            if map:IsA("Model") or map:IsA("Folder") then
                table.insert(list, map.Name)
            end
        end
    end
    table.sort(list, function(a,b) return a:lower() < b:lower() end)
    return list
end

local function runAutoJoin()
    if not SelectedMap then 
        Rayfield:Notify({Title = "Missing Information", Content = "Please select a map before starting!", Duration = 3})
        return 
    end

    local hrp = lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    if SelectedMode == "Story" then
        RemoteEvent:FireServer("battle_start", "story", SelectedMap, tonumber(SelectedAct), SelectedDifficulty)
        print("üöÄ Started Story: " .. SelectedMap)
    elseif SelectedMode == "Raid" then
        local raidFolder = workspace:WaitForChild("Rooms"):WaitForChild("raid")
        for _, roomModel in ipairs(raidFolder:GetChildren()) do
            local touchPart = roomModel:FindFirstChild("Touch", true)
            if touchPart and touchPart:IsA("BasePart") then
                firetouchinterest(hrp, touchPart, 0)
                task.wait(0.1)
                firetouchinterest(hrp, touchPart, 1)
                task.wait(0.5)
                RemoteEvent:FireServer("room_select", SelectedMap, 1)
                task.wait(0.3)
                RemoteEvent:FireServer("room_start")
                print("‚úÖ Started Raid: " .. SelectedMap)
                break
            end
        end
    end
end

-- ================= UI TAB 1 ‚Äî LOBBY / FARM =================
local Main = Window:CreateTab("Lobby / Farm", 4483362458)
local MapDropdown

Main:CreateDropdown({
    Name = "1. Select Mode",
    Options = {"Story","Raid"},
    CurrentOption = {"Story"},
    Flag = "SelectedMode",
    Callback = function(opt)
        SelectedMode = opt[1]
        if MapDropdown then
            MapDropdown:Refresh(SelectedMode == "Raid" and RaidMaps or getSortedMaps(), true)
        end
    end
})

MapDropdown = Main:CreateDropdown({
    Name = "2. Select Map",
    Options = getSortedMaps(),
    CurrentOption = {},
    Flag = "SelectedMap",
    Callback = function(opt) SelectedMap = opt[1] end
})

Main:CreateDropdown({
    Name = "3. Select Act",
    Options = {"1","2","3","4","5","6","7","8","9","10"},
    CurrentOption = {"1"},
    Flag = "SelectedAct",
    Callback = function(opt) SelectedAct = opt[1] end
})

Main:CreateDropdown({
    Name = "4. Difficulty",
    Options = {"Normal","Hard","Nightmare"},
    CurrentOption = {"Normal"},
    Flag = "SelectedDifficulty",
    Callback = function(opt) SelectedDifficulty = opt[1] end
})

Main:CreateToggle({
    Name = "Auto Join & Start",
    CurrentValue = false,
    Flag = "AutoJoin",
    Callback = function(val)
        if val then
            runAutoJoin()
            Rayfield:Notify({Title = "KazeHub", Content = "Joining match...", Duration = 2})
        end
    end
})

-- ================= TOWER DEFENSE RESULT + DISCORD WEBHOOK (UPGRADED) =================
local http_request =
    (syn and syn.request)
    or (http and http.request)
    or (fluxus and fluxus.request)
    or request

-- Load saved webhook from file
pcall(function()
    if isfile("custom_webhook.txt") then
        customWebhook = readfile("custom_webhook.txt")
        print("üíæ Webhook loaded from file")
    end
end)

-- UI PATH
local resultUI = lp.PlayerGui:WaitForChild("battle"):WaitForChild("Result")
local content = resultUI:WaitForChild("Base"):WaitForChild("Content")
local resultLabel  = content:WaitForChild("Result")
local rewardFolder = content:WaitForChild("Rewards")
local stageLabel   = content:WaitForChild("Stage")

-- DATA FUNCTIONS
local function getTotalBalance()
    local data = lp:FindFirstChild("Data")
    if not data then return "Data not found" end
    local coins = data:FindFirstChild("Coins")
    local gems  = data:FindFirstChild("Gems")
    return string.format("üí∞ **Coins:** %s\nüíé **Gems:** %s", coins and coins.Value or 0, gems and gems.Value or 0)
end

local function getMatchRewards()
    local rewards = {}
    for _, item in ipairs(rewardFolder:GetChildren()) do
        local qty = item:FindFirstChild("Quantity")
        if qty and qty:IsA("TextLabel") and qty.Text ~= "" then
            table.insert(rewards, "‚Ä¢ **" .. item.Name .. "**: " .. qty.Text)
        end
    end
    return #rewards > 0 and table.concat(rewards, "\n") or "No rewards found"
end

-- SEND DISCORD SAFE + RETRY
local sent = false
local maxRetry = 3

local function sendDiscordSafe()
    if customWebhook == "" then
        warn("‚ö†Ô∏è No webhook entered, cannot send results")
        return
    end

    repeat task.wait(0.1) until resultLabel.Text ~= "" and stageLabel.Text ~= ""
    local resultText = resultLabel.Text
    local textLower = resultText:lower()
    local isWin = textLower:find("win") or textLower:find("victory") or textLower:find("victorious")

    local data = {
        username = "Tower Defense Report",
        embeds = {{
            title = (isWin and "üèÜ VICTORY" or "üíÄ DEFEAT") .. " | MATCH RESULT",
            color = isWin and 0x2ecc71 or 0xe74c3c,
            description = "üë§ **Player:** `" .. lp.Name .. "`\n" .. "üó∫ **Stage:** `" .. stageLabel.Text .. "`",
            fields = {
                { name = "üéÅ MATCH REWARDS", value = getMatchRewards(), inline = false },
                { name = "üí∞ TOTAL BALANCE", value = getTotalBalance(), inline = false },
            },
            footer = { text = "Sent at " .. os.date("%H:%M:%S") },
            timestamp = os.date("!%Y-%m-%dT%H:%M:%S.000Z")
        }}
    }

    local success = false
    for i = 1, maxRetry do
        local ok, err = pcall(function()
            http_request({
                Url = customWebhook,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(data)
            })
        end)
        if ok then
            success = true
            print("‚úÖ Webhook result sent on attempt #" .. i)
            break
        else
            warn("‚ö†Ô∏è Failed to send webhook attempt #" .. i, err)
            task.wait(1)
        end
    end
    if not success then
        warn("‚ùå All webhook attempts failed")
    end
end

-- TRIGGER
resultUI:GetPropertyChangedSignal("Visible"):Connect(function()
    if resultUI.Visible and not sent then
        sent = true
        task.spawn(sendDiscordSafe)
    elseif not resultUI.Visible then
        sent = false
    end
end)

-- ================= UI WEBHOOK PANEL =================
local Tab2 = Window:CreateTab("Webhook", 4483362458)
Tab2:CreateInput({
    Name = "Webhook Link",
    CurrentValue = customWebhook,
    PlaceholderText = "Paste Discord webhook here",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text) customWebhook = Text end,
})

Tab2:CreateButton({
    Name = "Test Webhook",
    Callback = function()
        if customWebhook == "" then
            warn("‚ö†Ô∏è Webhook not entered")
            Rayfield:Notify({Title = "Webhook", Content = "Please enter a webhook link!", Duration = 2.5, Image = 4483362458})
            return
        end
        local testData = {username = "Webhook Tester", embeds = {{title = "‚úÖ TEST WEBHOOK", description = "Webhook is working correctly!", color = 0x3498db}}}
        local success, err = pcall(function()
            http_request({Url = customWebhook, Method = "POST", Headers = {["Content-Type"]="application/json"}, Body = HttpService:JSONEncode(testData)})
        end)
        if success then
            Rayfield:Notify({Title="Webhook", Content="‚úÖ Test Webhook successful!", Duration=2.5, Image=4483362458})
        else
            Rayfield:Notify({Title="Webhook", Content="‚ùå Test Webhook failed!", Duration=2.5, Image=4483362458})
            warn("‚ùå Test webhook failed", err)
        end
    end,
})

Tab2:CreateButton({
    Name = "Save Webhook",
    Callback = function()
        if customWebhook ~= "" then
            writefile("custom_webhook.txt", customWebhook)
            Rayfield:Notify({Title="Webhook", Content="üíæ Webhook saved successfully!", Duration=2.5, Image=4483362458})
        else
            Rayfield:Notify({Title="Webhook", Content="‚ö†Ô∏è Please enter a webhook link!", Duration=2.5, Image=4483362458})
        end
    end,
})

-- ================= UI TAB 3 ‚Äî MISC =================
local MiscTab = Window:CreateTab("Misc", 4483362458)

-- ANTI-AFK
local AntiAFKEnabled = false
local AntiAFKThread
local AntiAFKConnection

local function StartAntiAFK()
    if AntiAFKEnabled then return end
    AntiAFKEnabled = true
    AntiAFKConnection = lp.Idled:Connect(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new(0,0))
    end)
    AntiAFKThread = task.spawn(function()
        while AntiAFKEnabled do
            task.wait(30)
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new(0,0))
        end
    end)
    print("üü¢ Anti-AFK started")
end

local function StopAntiAFK()
    AntiAFKEnabled = false
    if AntiAFKConnection then AntiAFKConnection:Disconnect() AntiAFKConnection=nil end
    if AntiAFKThread then task.cancel(AntiAFKThread) AntiAFKThread=nil end
    print("üî¥ Anti-AFK stopped")
end

MiscTab:CreateToggle({
    Name = "Anti-AFK",
    CurrentValue = false,
    Flag = "AntiAFK",
    Callback = function(Value)
        if Value then
            StartAntiAFK()
            Rayfield:Notify({Title="Anti-AFK", Content="‚úÖ Anti-AFK enabled", Duration=2.5, Image=4483362458})
        else
            StopAntiAFK()
            Rayfield:Notify({Title="Anti-AFK", Content="‚ùå Anti-AFK disabled", Duration=2.5, Image=4483362458})
        end
    end
})

-- FPS BOOST
local FPSBoostEnabled = false
MiscTab:CreateToggle({
    Name = "FPS Boost",
    CurrentValue = false,
    Flag = "FPSBoost",
    Callback = function(Value)
        FPSBoostEnabled = Value
        if Value then
            for _, v in pairs(Workspace:GetDescendants()) do
                if v:IsA("Part") or v:IsA("UnionOperation") or v:IsA("MeshPart") then
                    v.Material = Enum.Material.Plastic
                    v.Reflectance = 0
                end
            end
            Lighting.GlobalShadows = false
            Lighting.FogEnd = 9e9
            Lighting.Brightness = 2
            Workspace.StreamingEnabled = false
            for _, particle in pairs(Workspace:GetDescendants()) do
                if particle:IsA("ParticleEmitter") or particle:IsA("Trail") then
                    particle:Destroy()
                end
            end
            Rayfield:Notify({Title="Performance", Content="üöÄ FPS Boost enabled", Duration=2.5, Image=4483362458})
        else
            Lighting.GlobalShadows = true
            Workspace.StreamingEnabled = true
            Rayfield:Notify({Title="Performance", Content="‚öôÔ∏è FPS Boost disabled", Duration=2.5, Image=4483362458})
        end
    end
})

-- SAVE CONFIG
MiscTab:CreateButton({
    Name = "Save Config",
    Callback = function()
        Rayfield:SaveConfiguration()
        Rayfield:Notify({Title="Config", Content="üíæ Configuration saved successfully!", Duration=2.5, Image=4483362458})
    end
})

-- REJOIN
MiscTab:CreateButton({
    Name = "Rejoin",
    Callback = function()
        Rayfield:Notify({Title="Rejoin", Content="‚è≥ Rejoining server...", Duration=2.5, Image=4483362458})
        TeleportService:Teleport(game.PlaceId, lp)
    end
})

-- LOAD CONFIG
Rayfield:LoadConfiguration()
print("‚úÖ KazeHub Loaded Complete + Webhook Fixed")
